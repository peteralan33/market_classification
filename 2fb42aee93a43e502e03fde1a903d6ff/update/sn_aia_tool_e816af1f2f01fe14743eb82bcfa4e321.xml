<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="sn_aia_tool">
    <sn_aia_tool action="INSERT_OR_UPDATE">
        <active>true</active>
        <description>Role: You are a dedicated Trade Reconciliation Analyst responsible for automatically structuring data for unmatched trades. Your input is unstructured text (emails, documents) that may contain details for multiple unmatched trades.

Input: Unstructured text, including email content and attached document data, which contains details for multiple unmatched trades.

Objective: Your sole task is to analyze the input text and identify ALL distinct unmatched trades. For each trade identified, you MUST create a separate record,  containing all specified data points, listed below, to trigger the creation of a new, actionable investigation Task in the downstream system.

Goal: Your single goal is to analyze all the input text. For every distinct unmatched trade you find, you must create one separate, complete activity record.

Key Considerations 
--&gt; DO NOT CREATE DUPLICATE RECORDS
--&gt; DO NOT PLACE MULTIPLE TRADES IN ONE RECORD

MAPPING RULES AND EXTRACTION GUIDANCE
Case Management Fields (High-Level Context)
Key Name: Current_Case_Record --&gt; What to Find: The unique identifier for the current underlying case or task (System Context).

Trade Detail Fields (Transaction Specific)
Key Name: Short_Description --&gt; What to Find: A concise summary of the task. --&gt; Required Format: MUST be constructed as: "Unmatched Trade: [Instrument_Name] - [Reference_Number]".

Key Name: ISIN --&gt; What to Find: The 12-character alphanumeric security identifier. --&gt; Required Format: Must start with a two-letter country code (e.g., 'US', 'FR'). --&gt; Missing Data Policy: If not found, use the value "N/A".

Key Name: Reference_Number --&gt; What to Find: The unique trade identifier (Deal ID, Trade Reference, or Confirmation Number). --&gt; Missing Data Policy: If not found, use the value "N/A".

Key Name: Trade_Date --&gt; What to Find: The date the trade was executed. --&gt; Required Format: Strictly YYYY-MM-DD (e.g., '2025-10-27'). --&gt; Missing Data Policy: If not found, use the value "N/A".

Key Name: Settlement_Date --&gt; What to Find: The date the trade is scheduled to settle (Value Date). --&gt; Required Format: Strictly YYYY-MM-DD. --&gt; Missing Data Policy: If not found, use the value "N/A".

Key Name: Direction --&gt; What to Find: Whether the transaction was a Buy or a Sell. --&gt; Required Value: MUST be either "Buy" or "Sell". --&gt; Missing Data Policy: If ambiguous or not found, use the value "UNCLEAR".

Key Name: Settlement_Amount --&gt; What to Find: The total monetary value of the trade. --&gt; Required Format: Numeric value only (no currency symbols or text). Use standard decimal notation (e.g., '1250000.50'). --&gt; Missing Data Policy: If not found or ambiguous, use the value 0.

Key Name: Instrument_Name --&gt; What to Find: The full, descriptive name of the security. --&gt; Missing Data Policy: If not found, use the value "N/A".

Key Name: Quantity --&gt; What to Find: The quantity of shares, bonds, or contracts traded. --&gt; Missing Data Policy: If not found, use the value 0.

Key Name: Price_Per_Share --&gt; What to Find: The price per unit of the security. --&gt; Missing Data Policy: If not found, use the value 0.00.

Key Name: Source --&gt; Extraction Logic: This value will be defaulted. --&gt; Default Value: Always use the literal value "Attachment".

Example Output 
Current_Case_Record: WIR0000NNN
Account: Boxeo Investments
Contact: Jane Doe
Short_Description: Unmatched Trade: INVESCO QQQ TRUST ETF - 95004413
ISIN: US46090E1035
Reference_Number: 95004413
Trade_Date: 2025-12-01
Settlement_Date: 2025-12-02
Direction: Buy
Settlement_Amount: 2580000.00
Instrument_Name: INVESCO QQQ TRUST ETF
Quantity: 6000
Price_Per_Share: 430.00
Source: Email
---
Trade Activity Record 2
(Continue all fields for every trade found)</description>
        <input_schema>[{"name":"Current_Case_Record","description":"The current case the task is being ran on","mandatory":true},{"name":"ISIN","description":"International Securities Identification Number","mandatory":true},{"name":"Reference_Number","description":"The reference number outlined for each order","mandatory":true},{"name":"Trade_Date","description":"Trade Date","mandatory":true},{"name":"Settlement_Date","description":"Settlement / Value Date","mandatory":true},{"name":"Direction","description":"Buy or Sell","mandatory":true},{"name":"Settlement_Amount","description":"Settlement Amount","mandatory":true},{"name":"Instrument_Name","description":"Instrument Name","mandatory":true},{"name":"Quantity","description":"Volume of the trade","mandatory":true},{"name":"ShortDesc","description":"Overview of the task","mandatory":true},{"name":"Description","description":"The detailed description of the task","mandatory":true},{"name":"Price_Per_Share","description":"The price per share that was traded","mandatory":true},{"name":"Source","description":"Attachment","mandatory":true},{"name":"crudInputs","description":"CRUD Input Variables. These are already pre-defined. Under no circumstances should you prompt the user for this information or attempt to change these values."}]</input_schema>
        <name>Create Unmatched Trade Activity</name>
        <record_type>custom</record_type>
        <script><![CDATA[(function (inputs) {
    function getChoiceList(tableName, fieldName) {
        var choices = GlideChoiceList.getChoiceList(tableName, fieldName);
        if (!choices) return [];

        var choicesArray = [];
        for (var i = 0; i < choices.getSize(); i++) {
            choicesArray.push({
                value: choices.getChoice(i).getValue(),
                label: choices.getChoice(i).getLabel(),
            });
        }
        return choicesArray;
    }

    // parses {{value}} and obtains the correct value for a choice or reference field.
    function parseValue(table, value, field, inputs) {
        if (!value || typeof value === 'object') return '';
        // regex to parse {{var}} and check if the inputs contain that prop
        var fieldValue = value.replace(
            /{{\s*(\w+)\s*}}/g,
            function (match, variableName) {
                if (inputs && inputs.hasOwnProperty(variableName)) {
                    return inputs[variableName];
                }
                return '';
            }
        );
        if (!fieldValue) return field.type === 'string' ? '' : null;
        if (field.type === 'choice') {
            var choices = getChoiceList(table, field.id);
            for (var i = 0; i < choices.length; i++) {
                if (
                    choices[i].value == fieldValue ||
                    choices[i].label
                        .toLowerCase()
                        .includes(fieldValue.toLowerCase())
                ) {
                    return choices[i].value;
                }
            }
            // Neither value nor label matched
            gs.error(
                '[AIA AGENTS MSG] Invalid choice field value or label: {0}',
                fieldValue
            );
        } else if (field.referenceTable) {
            // First check if the input is a valid sys_id
            var refGr = new GlideRecordSecure(field.referenceTable);
            refGr.addQuery('sys_id', fieldValue);
            refGr.query();
            if (refGr.getRowCount() === 1) {
                return fieldValue; // User input is a valid sys_id
            }

            if (field.referenceTableDefaultField) {
                // If not, try to find a record with matching display value
                var refName = field.referenceTableDefaultField;
                refGr = new GlideRecordSecure(field.referenceTable);

                // Check for both exact match and display value containing the input
                var qr = refGr.addQuery(refName, fieldValue);
                qr.addOrCondition(refName, 'CONTAINS', fieldValue);
                refGr.setLimit(1);
                refGr.query();

                if (refGr.next()) {
                    return refGr.getUniqueValue(); // Return the sys_id
                }
            }
            // No match found
            gs.error(
                '[AIA AGENTS MSG] Invalid reference field value or label: {0}',
                fieldValue
            );
        }
        return fieldValue;
    }

    var table = inputs.crudInputs.table.value;
    var tableName = inputs.crudInputs.table.displayValue;
    var fieldValues = inputs.crudInputs.fieldValues
        ? inputs.crudInputs.fieldValues
        : [];
    // each field is passed as an {id, label} obj to be displayed when editing the tool
    // each value is not passed directly, but in an object containing the fieldValue prop
    fieldValues = fieldValues.map(function (item) {
        var fieldValue = item.value ? item.value.fieldValue : '';
        return {
            field: item.field.id,
            value: parseValue(table, fieldValue, item.field, inputs),
        };
    });

    var gr = new GlideRecordSecure(table);
    if (gr.canCreate()) {
        gr.initialize();
        fieldValues.forEach(function (item) {
            if (gr.isValidField(item.field)) {
                gr.setValue(item.field, item.value);
            }
        });
    } else {
        return {
            output: sn_i18n.Message.getMessage(
                'sn_aia',
                'Cannot create record due to security constraints.'
            ),
            status: sn_i18n.Message.getMessage('sn_aia', 'error'),
        };
    }
    var sysId = gr.insert();

    if (!sysId) {
        gs.error('[AIA AGENTS MSG] Failed to insert the record.');
        return {
            output: sn_i18n.Message.getMessage(
                'sn_aia',
                'Failed to insert the record'
            ),
            status: sn_i18n.Message.getMessage('sn_aia', 'error'),
        };
    }
    return {
        sysId: sysId,
        message: sn_i18n.Message.getMessage(
            'sn_aia',
            'Record successfully inserted into the {table} table.',
            {
                table: tableName,
            }
        ),
        status: sn_i18n.Message.getMessage('sn_aia', 'success'),
    };
})(inputs);
]]></script>
        <sys_class_name>sn_aia_tool</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-11-12 05:09:22</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_id>e816af1f2f01fe14743eb82bcfa4e321</sys_id>
        <sys_mod_count>24</sys_mod_count>
        <sys_name>Create Unmatched Trade Activity</sys_name>
        <sys_overrides/>
        <sys_package display_value="Pete's Market Classifications Toolkit" source="x_snc_pab_mc_tkit">2fb42aee93a43e502e03fde1a903d6ff</sys_package>
        <sys_policy/>
        <sys_scope display_value="Pete's Market Classifications Toolkit">2fb42aee93a43e502e03fde1a903d6ff</sys_scope>
        <sys_update_name>sn_aia_tool_e816af1f2f01fe14743eb82bcfa4e321</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-11-30 19:58:11</sys_updated_on>
        <target_document/>
        <target_document_table>sn_aia_tool</target_document_table>
        <type>crud</type>
    </sn_aia_tool>
</record_update>
